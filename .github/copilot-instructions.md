## Quick orientation for coding agents

This repository implements a Python wrapper around OPA (Open Policy Agent) policies packaged as a WASM/tar bundle.
Keep the guidance below short and concrete so you can be productive immediately.

### Big picture
-- Policy layers live under the `.governant/` directory: `policies/`, `schemas/` and `code/` (Rego files).
- The Python runtime loads an OPA WASM bundle (default: `.compile/github_env_protect.tar.gz`) and exposes helpers in `src/opawasm/` (`PolicyEngine`, CLI in `src/opawasm/cli.py`).
- Typical flows:
  - CI/Workflows build an `input` JSON (see `test-inputs/`) and call the CLI or library to evaluate `data.github.deploy.allow` or `data.github.deploy.violations`.
  - Bundles are generated by scripts (see `scripts/compile_github_env_protect_policy.sh`) and consumed by `PolicyEngine`.

### Key files and examples
- `src/opawasm/main.py` — core `PolicyEngine` wrapper around `opa-wasm` Python API. Important: it supports multiple runtime signatures (bundles vs wasm; `from_bundle`, `path`, `wasm` kwargs).
- `src/opawasm/cli.py` — CLI (`policy`) with subcommands: `allow`, `violations`, `eval`, `version`. Use `--artifact` to change the bundle, `--quiet` and `--strict-exit` for CI behavior.
- `.compile/github_env_protect.tar.gz` — default bundle path referenced by `DEFAULT_ARTIFACT` in `main.py`.
.governant/ — holds `policies/`, `code/` and `schemas/` that define intent, schema and logic.
- `scripts/validate_schema.sh` and `scripts/validate_github_env_protect_rego.sh` — helper scripts for local validation (jq / opa checks).
- `test-inputs/` — sample inputs used by tests and manual `opa eval` runs (e.g. `production-valid.json`).

### Developer workflows (concrete commands)
- Install dependencies and dev tools:
  - poetry install
  - Install OPA (used for Rego checks): see README; or `brew install opa` on macOS.
- Run Python unit tests:
  - `poetry run pytest -v` (project uses pytest and pytest-cov)
- Run CLI locally with a test input:
  - `poetry run python -m opawasm.cli allow -i test-inputs/production-valid.json` (or `policy allow -i ...` if installed)
  - To exit non-zero on denial (CI): add `--strict-exit`.
- Check Rego syntax / evaluate policy with OPA:
  - `opa check .governant/code/*.rego`
  - `opa eval --data .governant/code/github_env_protect.rego --input test-inputs/production-valid.json "data.github.deploy.allow"`
- Validate policy JSON against schema (local script):
  - `./scripts/validate_schema.sh`

### Project-specific patterns and conventions
- Entrypoints: code normalizes Rego entrypoints to `data.*` form. Accepts `github/deploy/allow`, `github.deploy.allow`, or `data.github.deploy.allow`.
- Policy bundle detection: `PolicyEngine` treats `.tar.gz`, `.tgz`, `.zip` as bundles and prefers `from_bundle` when available. When changing or adding runtime libs, keep these initialization fallbacks in mind.
- Exit codes: CLI uses specific non-zero exit codes for CI integration: `2` commonly used on deny (but note `cli._exit_for_allow` currently returns `0` when not strict). Use `--strict-exit` to enforce non-zero on deny/violations.
- Tests and coverage: `pyproject.toml` configures pytest paths and coverage; run via Poetry.

### Integration points & external deps
- `opa-wasm` Python package (runtime) — used to run policies from Python. The code contains heuristics for multiple versions; if upgrading the package, verify constructor/API compatibility.
- OPA CLI — used by scripts and local manual testing for Rego checks and `opa eval`.
- CI expects the policy CLI to be callable in scripts and workflows. Keep `--artifact`, `--quiet`, and `--strict-exit` flags stable.

### When you edit policies or the engine
- If you change `.governant/code/*.rego` or `policies/*`:
  - Update or re-generate the bundle using `scripts/compile_github_env_protect_policy.sh`.
  - Validate Rego with `opa check` and JSON with `./scripts/validate_schema.sh`.
  - Run `poetry run pytest` to ensure no regressions in Python helpers.

### Useful snippets for the repo
- Evaluate allow from stdin (CI style):
  - `cat test-inputs/production-valid.json | poetry run python -m opawasm.cli allow -i - --strict-exit`
- Quick policy evaluation using the Python API (from tests or scripts):
  - from opawasm.main import PolicyEngine; eng = PolicyEngine(); eng.allow(json.load(...))

### Limitations (what an agent should not assume)
- Do not assume a single stable API for `opa-wasm` — tests and runtime code adapt for multiple versions. If you upgrade, add compatibility code or update `_load_policy` heuristics.
- The repository expects bundles to exist at `.compile/...`. CI may build bundles separately; check workflows if a new workflow is added.

If anything above is unclear or you want more examples (tests, workflows, or Rego patterns), tell me which area to expand and I'll iterate.
